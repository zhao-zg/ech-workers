name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache: false
    
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/go/pkg/mod
          ~/.cache/go-build
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install NDK
      run: |
        sdkmanager --install "ndk;26.3.11579264"
        echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/26.3.11579264" >> $GITHUB_ENV
    
    - name: Install gomobile
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        go install golang.org/x/mobile/cmd/gobind@latest
        gomobile init
    
    - name: Prepare Go module
      run: |
        go work init
        go work use . ./tunnel ./mobile
        cd mobile
        go mod tidy
        go get golang.org/x/mobile/bind
    
    - name: Build Go library
      run: |
        export PATH=$PATH:$(go env GOPATH)/bin
        cd mobile
        echo "Building AAR with gomobile..."
        gomobile bind -v -target=android -androidapi=24 -o ../android/ech-workers.aar .
        echo "gomobile bind completed successfully"
        cd ..
        ls -lh android/ech-workers.aar
    
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: 8.5
    
    - name: Create VERSION file and set environment
      run: |
        VERSION="${{ github.ref_name }}"
        echo "Creating VERSION file with: $VERSION"
        echo "$VERSION" > VERSION
        echo "VERSION file created:"
        cat VERSION
        echo "Setting GITHUB_REF_NAME environment variable"
        echo "GITHUB_REF_NAME=$VERSION" >> $GITHUB_ENV
    
    - name: Verify version setup
      run: |
        echo "GITHUB_REF_NAME env var: $GITHUB_REF_NAME"
        echo "VERSION file content:"
        cat VERSION
        echo "Git tag:"
        git describe --tags --abbrev=0 || echo "No git tag found"
    
    - name: Build APK (Debug)
      working-directory: ./android
      env:
        GITHUB_REF_NAME: ${{ github.ref_name }}
      run: |
        echo "========================================="
        echo "Building APK with version: $GITHUB_REF_NAME"
        echo "========================================="
        chmod +x gradlew
        ./gradlew clean
        ./gradlew assembleDebug --info | grep -E "(version|VERSION|Using version)"
        echo "========================================="
        echo "Build complete, checking outputs:"
        ls -lh build/outputs/apk/debug/ || true
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: android/build/outputs/apk/debug/*.apk

  build-openwrt:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64, aarch64_generic]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
    
    - name: Cache OpenWrt SDK
      uses: actions/cache@v4
      with:
        path: openwrt-sdk
        key: openwrt-sdk-23.05.5-${{ matrix.arch }}
    
    - name: Download and extract OpenWrt SDK
      run: |
        if [ ! -d "openwrt-sdk" ]; then
          case "${{ matrix.arch }}" in
            x86_64)
              SDK_URL="https://downloads.openwrt.org/releases/23.05.5/targets/x86/64/openwrt-sdk-23.05.5-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
              ;;
            aarch64_generic)
              SDK_URL="https://downloads.openwrt.org/releases/23.05.5/targets/armsr/armv8/openwrt-sdk-23.05.5-armsr-armv8_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
              ;;
          esac
          wget -q "$SDK_URL" -O sdk.tar.xz
          mkdir -p openwrt-sdk
          tar -xf sdk.tar.xz --strip-components=1 -C openwrt-sdk
          rm sdk.tar.xz
        fi
    
    - name: Prepare Go workspace
      run: |
        go work init
        go work use . ./tunnel
    
    - name: Build Go binary
      run: |
        # 获取版本号（移除 v 前缀）
        VERSION=${GITHUB_REF#refs/tags/}
        echo "Building version: $VERSION"
        
        cd cmd/ech-workers
        case "${{ matrix.arch }}" in
          x86_64)
            GOARCH=amd64 CGO_ENABLED=0 go build -o ../../openwrt/ech-workers -ldflags="-s -w -X github.com/zhao-zg/ech-workers/tunnel.Version=$VERSION" .
            ;;
          aarch64_generic)
            GOARCH=arm64 CGO_ENABLED=0 go build -o ../../openwrt/ech-workers -ldflags="-s -w -X github.com/zhao-zg/ech-workers/tunnel.Version=$VERSION" .
            ;;
        esac
    
    - name: Build OpenWrt packages
      run: |
        # 设置版本环境变量
        VERSION="${{ github.ref_name }}"
        VERSION_NUM="${VERSION#v}"
        echo "Building with version: $VERSION_NUM"
        
        cd openwrt-sdk
        # Copy package directories directly to SDK
        mkdir -p package/ech-workers
        cp -r ../openwrt/* package/ech-workers/
        mkdir -p package/luci-app-ech-workers
        cp -r ../openwrt/luci-app-ech-workers/* package/luci-app-ech-workers/
        # Use defconfig instead of menuconfig
        make defconfig
        # Build packages with version override
        make package/ech-workers/compile V=s PKG_VERSION_OVERRIDE="$VERSION_NUM"
        make package/luci-app-ech-workers/compile V=s PKG_VERSION_OVERRIDE="$VERSION_NUM"
    
    - name: Find and copy packages
      run: |
        mkdir -p artifacts
        find openwrt-sdk/bin -name "ech-workers_*.ipk" -exec cp {} artifacts/ \;
        find openwrt-sdk/bin -name "luci-app-ech-workers_*.ipk" -exec cp {} artifacts/ \;
        ls -lh artifacts/
    
    - name: Upload OpenWrt packages
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-${{ matrix.arch }}
        path: artifacts/*.ipk

  create-release:
    needs: [build-android, build-openwrt]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download Android artifacts
      uses: actions/download-artifact@v4
      with:
        name: android-apk
        path: artifacts/android
    
    - name: Download OpenWrt artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: openwrt-*
        path: artifacts/openwrt
        merge-multiple: true
    
    - name: List all artifacts
      run: |
        echo "Android APKs:"
        ls -lh artifacts/android/
        echo "OpenWrt IPKs:"
        ls -lh artifacts/openwrt/
    
    - name: Extract version
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        name: Release ${{ steps.version.outputs.VERSION }}
        body: |
          ## ECH-Workers ${{ steps.version.outputs.VERSION }}
          
          ### 功能特性
          - ✅ 支持 ECH (Encrypted Client Hello) 加密
          - ✅ SOCKS5/HTTP 代理支持
          - ✅ 智能分流（全局代理/跳过中国大陆/直连）
          - ✅ 自动更新中国 IP 列表
          - ✅ Android 和 OpenWrt 双平台支持
          
          ### 下载说明
          
          **Android 客户端:**
          - APK 文件支持 armeabi-v7a, arm64-v8a, x86, x86_64 架构
          
          **OpenWrt 软件包:**
          - `ech-workers_*_x86_64.ipk` - x86_64 架构
          - `ech-workers_*_aarch64.ipk` - ARM64 架构
          - `luci-app-ech-workers_*.ipk` - LuCI Web 界面（所有架构通用）
          
          ### 安装方法
          
          **Android:**
          ```bash
          # 下载 APK 文件后直接安装
          adb install ech-workers-*.apk
          ```
          
          **OpenWrt:**
          ```bash
          # 上传 IPK 文件到路由器
          opkg update
          opkg install ech-workers_*.ipk
          opkg install luci-app-ech-workers_*.ipk
          
          # 启动服务
          /etc/init.d/ech-workers enable
          /etc/init.d/ech-workers start
          ```
          
          ### 配置说明
          
          详细配置说明请参考项目 README.md
        draft: false
        prerelease: false
        files: |
          artifacts/android/*.apk
          artifacts/openwrt/*.ipk
